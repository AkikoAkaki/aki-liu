{{ define "main" }}
<article class="post-single">
    <header class="post-header">
        <h1 class="post-title">{{ .Title }}</h1>
        <time class="post-date">{{ .Date.Format "2006/01/02" }}</time>
    </header>

    <div class="post-content">
        {{ .Content }}
    </div>
</article>

<footer class="site-footer">
    <div class="footer-left">Sit with your ambient ambition.</div>
    <div class="footer-right">
        <span class="footer-year">{{ now.Format "2006" }}</span>
        <span class="footer-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        </span>
    </div>
</footer>
{{ end }}

{{ define "sidebar-right" }}
    {{ $toc := .TableOfContents }}
    {{ with $toc }}
        {{ if gt (len (plainify .)) 0 }}
        <aside class="post-toc">
            {{ . | safeHTML }}
        </aside>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const tocLinks = document.querySelectorAll('.post-toc a');
                const headings = Array.from(document.querySelectorAll('.post-content h1, .post-content h2, .post-content h3, .post-content h4, .post-content h5, .post-content h6'))
                    .filter(h => h.id);
                
                if (tocLinks.length === 0 || headings.length === 0) return;

                let activeIndex = 0;

                const updateActive = () => {
                    // Threshold: 3/4 of screen height from top (75vh)
                    const threshold = window.innerHeight * 0.75;
                    
                    // Find the last heading that has passed the threshold
                    let newIndex = 0;
                    for (let i = 0; i < headings.length; i++) {
                        if (headings[i].getBoundingClientRect().top <= threshold) {
                            newIndex = i;
                        } else {
                            break;
                        }
                    }

                    if (newIndex !== activeIndex) {
                        tocLinks[activeIndex]?.classList.remove('is-active');
                        activeIndex = newIndex;
                        tocLinks[activeIndex]?.classList.add('is-active');
                    }
                };

                // Initial check
                updateActive();

                window.addEventListener('scroll', updateActive, { passive: true });
            });
        </script>
        {{ end }}
    {{ end }}
{{ end }}
