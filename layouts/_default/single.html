{{ define "main" }}
<article class="post-single">
    <header class="post-header">
        {{ $backHref := .Site.Home.RelPermalink }}
        {{ $backLabel := "Index" }}
        {{ with .CurrentSection }}
            {{ $backHref = .RelPermalink }}
            {{ $backLabel = .Title }}
        {{ end }}
        <div class="title-with-back">
            <a class="back-link" href="{{ $backHref }}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 12h14" />
                    <path d="M11 6l-6 6 6 6" />
                </svg>
                <span>{{ $backLabel }}</span>
            </a>
            <h1 class="post-title">{{ .Title }}</h1>
        </div>
        <time class="post-date">{{ .Date.Format "2006/01/02" }}</time>
    </header>

    <div class="post-content">
        {{ .Content }}
    </div>
</article>
{{ end }}

{{ define "sidebar-right" }}
{{ if .TableOfContents }}
<aside class="post-toc">
    {{ .TableOfContents }}
</aside>
<script>
(function() {
    const toc = document.querySelector('.post-toc');
    if (!toc) return;
    
    const links = toc.querySelectorAll('a');
    const headings = Array.from(links).map(link => {
        const id = link.getAttribute('href').slice(1);
        return document.getElementById(id);
    }).filter(Boolean);
    
    // Smooth scroll with 25% from top positioning
    links.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const id = link.getAttribute('href').slice(1);
            const target = document.getElementById(id);
            if (target) {
                const targetPosition = target.getBoundingClientRect().top + window.pageYOffset;
                const offsetPosition = targetPosition - (window.innerHeight * 0.25);
                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
            }
        });
    });
    
    // Highlight active heading on scroll
    function highlightActiveHeading() {
        let current = null;
        const scrollPos = window.scrollY + (window.innerHeight * 0.26);
        
        for (let i = headings.length - 1; i >= 0; i--) {
            if (headings[i] && headings[i].offsetTop <= scrollPos) {
                current = headings[i];
                break;
            }
        }
        
        links.forEach(link => link.classList.remove('is-active'));
        if (current) {
            const activeLink = toc.querySelector(`a[href="#${current.id}"]`);
            if (activeLink) activeLink.classList.add('is-active');
        }
    }
    
    let ticking = false;
    window.addEventListener('scroll', () => {
        if (!ticking) {
            window.requestAnimationFrame(() => {
                highlightActiveHeading();
                ticking = false;
            });
            ticking = true;
        }
    });
    
    highlightActiveHeading();
})();
</script>
{{ end }}
{{ end }}
